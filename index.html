<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KOKUA｜カウンセリングシート</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --brand:#13ca5e;
      --ink:#222;
      --muted:#6b7280;
      --line:#e5e7eb;
      --bg:#f7f7f7;
      --danger:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"Noto Sans JP", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";background:var(--bg);color:var(--ink);}
    .wrap{max-width:680px;margin:0 auto;padding:20px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.05);overflow:hidden}
    .card-header{background:linear-gradient(135deg,var(--brand),#0fa958);color:#fff;padding:22px 20px}
    .title{margin:0;font-weight:700;font-size:20px;line-height:1.2}
    .sub{margin:6px 0 0;font-size:12px;opacity:.9}
    .card-body{padding:20px}

    .q{margin:18px 0}
    .q label.qtitle{display:block;font-weight:700;margin-bottom:10px}
    .badge{display:inline-block;vertical-align:middle;margin-right:8px;font-size:11px;padding:2px 6px;border-radius:6px}
    .req{background:#fff;color:var(--brand);border:1.5px solid var(--brand)}
    .opt{background:#eef9f5;color:#0f5132;border:1.5px solid #b7f7d2}

    input[type="text"], input[type="tel"], textarea, .field-help, .choice-grid{width:100%}
    input[type="text"], input[type="tel"], textarea{appearance:none;border:1px solid var(--line);border-radius:10px;padding:12px 14px;font-size:16px;transition:border .2s, box-shadow .2s}
    textarea{min-height:96px;resize:vertical}
    input:focus, textarea:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 4px rgba(19,202,94,.15)}
    .field-help{font-size:12px;color:var(--muted);margin-top:6px}

    .choice-grid{display:flex;gap:8px;flex-wrap:wrap}
    .choice-grid .chip{flex:1 1 calc(50% - 8px);min-width:140px;background:#f9fafb;border:1px solid var(--line);padding:10px 12px;border-radius:10px;text-align:center;cursor:pointer;user-select:none}
    .chip input{display:none}
    .chip.active{background:#1f2937;color:#fff;border-color:#1f2937}

    .hidden{display:none}
    .hr{height:1px;background:var(--line);margin:18px 0}

    .actions{padding:16px 20px;border-top:1px solid var(--line);background:#fff;position:sticky;bottom:0}
    .btn{width:100%;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 16px;border:none;border-radius:10px;background:#1f2937;color:#fff;font-weight:700;font-size:16px;cursor:pointer}
    $1

    /* 連打防止：無効化時の見た目 */
    .btn[disabled]{opacity:.6; pointer-events:none; filter:grayscale(20%);} 

    .error{font-size:12px;color:var(--danger);margin-top:6px}

    footer{margin:14px 0 0;text-align:center;color:var(--muted);font-size:11px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="card-header">
      <h1 class="title">KOKUA｜カウンセリングシート</h1>
      <p class="sub">※「必須」項目をご入力のうえ、下部の送信ボタンを押してください</p>
    </div>
    <div class="card-body" id="formRoot">

      <!-- ① お名前（必須） -->
      <div class="q" data-key="name">
        <label class="qtitle"><span class="badge req">必須</span>① お名前</label>
        <input type="text" id="name" placeholder="例）山田 花子" autocomplete="name" />
        <div class="error" data-err="name"></div>
      </div>

      <!-- ② お電話番号（必須） -->
      <div class="q" data-key="tel">
        <label class="qtitle"><span class="badge req">必須</span>② お電話番号</label>
        <input type="tel" id="tel" inputmode="tel" placeholder="例）090-1234-5678" autocomplete="tel" />
        <div class="field-help">ハイフン有り・無しどちらでも可</div>
        <div class="error" data-err="tel"></div>
      </div>

      <!-- ③ 生年月日（任意） -->
      <div class="q" data-key="birthday">
        <label class="qtitle"><span class="badge opt">任意</span>③ 生年月日</label>
        <input type="text" id="birthday" placeholder="例）1998/03/15" />
      </div>

      <!-- ④ お住まい（必須：回答例文をプレースホルダーに挿入） -->
      <div class="q" data-key="address">
        <label class="qtitle"><span class="badge req">必須</span>④ お住まい</label>
        <input type="text" id="address" placeholder="例）京都市中京区烏丸通◯◯　（最寄り：烏丸駅）」 />
        <div class="field-help">（構築担当メモ）回答欄に例文を表示しています。必要に応じて書き換えてください。</div>
        <div class="error" data-err="address"></div>
      </div>

      <!-- ⑤ アレルギー（必須：ある→自由記載表示） -->
      <div class="q" data-key="allergy">
        <label class="qtitle"><span class="badge req">必須</span>⑤ アレルギーはありますか？</label>
        <div class="choice-grid" role="group" aria-label="アレルギー">
          <label class="chip"><input type="radio" name="allergy" value="ある" />ある</label>
          <label class="chip"><input type="radio" name="allergy" value="なし" />なし</label>
        </div>
        <div id="allergyDetailWrap" class="hidden" aria-live="polite">
          <div class="hr"></div>
          <label class="qtitle" style="font-weight:600">アレルギー内容（自由記載）</label>
          <textarea id="allergyDetail" placeholder="例）花粉、金属（ニッケル）、化粧品（銘柄など）"></textarea>
          <div class="error" data-err="allergyDetail"></div>
        </div>
        <div class="error" data-err="allergy"></div>
      </div>

      <!-- ⑥ 過去にまつエク経験（必須：はい/いいえ） -->
      <div class="q" data-key="hadExtensions">
        <label class="qtitle"><span class="badge req">必須</span>⑥ 過去にまつエクを受けたことはありますか？</label>
        <div class="choice-grid" role="group" aria-label="まつエク経験">
          <label class="chip"><input type="radio" name="hadExtensions" value="はい" />はい</label>
          <label class="chip"><input type="radio" name="hadExtensions" value="いいえ" />いいえ</label>
        </div>
        <div class="error" data-err="hadExtensions"></div>
      </div>

      <!-- ⑦ 普段使用しているもの（必須：単一選択） -->
      <div class="q" data-key="eyeWear">
        <label class="qtitle"><span class="badge req">必須</span>⑦ 普段使用しているものはありますか？</label>
        <div class="choice-grid" role="group" aria-label="普段使用しているもの">
          <label class="chip"><input type="radio" name="eyeWear" value="メガネ" />メガネ</label>
          <label class="chip"><input type="radio" name="eyeWear" value="コンタクトレンズ" />コンタクトレンズ</label>
          <label class="chip"><input type="radio" name="eyeWear" value="なし" />なし</label>
        </div>
        <div class="error" data-err="eyeWear"></div>
      </div>

      <!-- ⑧ 希望スタイル（任意：回答例文をプレースホルダーに挿入） -->
      <div class="q" data-key="style">
        <label class="qtitle"><span class="badge opt">任意</span>⑧ 希望スタイル</label>
        <textarea id="style" placeholder="例）つり目にしたい／たれ目にしたい／目を大きくしたい など"></textarea>
      </div>

    </div>
    <div class="actions">
      <button class="btn" id="submitBtn" type="button">この内容で送信する</button>
      <footer>※ 送信するとLINEトークに自動送信されます</footer>
    </div>
  </div>
</div>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script>
  // ======== 設定（必ず修正） ========
  const LIFF_ID = "YOUR_LIFF_ID"; // ← あなたのLIFF IDに差し替え
  // ==================================

  // ユーティリティ
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

  // 送信ボタン多重タップ防止フラグ
  let isSubmitting = false;

  // ラジオ風チップのActive制御
  function initChips(){
    $$(".choice-grid").forEach(grid=>{
      grid.addEventListener("click", (e)=>{
        const lab = e.target.closest("label.chip");
        if(!lab) return;
        const input = lab.querySelector("input");
        const name = input?.name;
        if(!name) return;
        // 単一選択想定：同一nameのactiveを外して自分に付与
        $$("label.chip input[name='"+name+"']").forEach(i=>{
          i.closest("label.chip").classList.remove("active");
        });
        input.checked = true;
        lab.classList.add("active");
        onChange(name);
      });
    });
  }

  // 依存表示ロジック
  function onChange(name){
    if(name === "allergy"){
      const val = getRadioValue("allergy");
      const wrap = $("#allergyDetailWrap");
      if(val === "ある"){
        wrap.classList.remove("hidden");
      }else{
        wrap.classList.add("hidden");
        $("#allergyDetail").value = "";
      }
    }
  }

  function getRadioValue(name){
    const hit = $$("input[name='"+name+"']").find(i=>i.checked);
    return hit ? hit.value : "";
  }

  function validate(){
    let ok = true;
    // ①名前
    const name = $("#name").value.trim();
    const errName = $('[data-err="name"]');
    if(!name){ errName.textContent = "お名前は必須です"; ok = false; } else { errName.textContent = ""; }

    // ②電話
    const tel = $("#tel").value.trim();
    const errTel = $('[data-err="tel"]');
    const telOk = /^0\d{9,10}$/.test(tel.replace(/-/g, ''));
    if(!tel){ errTel.textContent = "お電話番号は必須です"; ok = false; }
    else if(!telOk){ errTel.textContent = "電話番号の形式をご確認ください（例：09012345678）"; ok = false; }
    else { errTel.textContent = ""; }

    // ④住所
    const address = $("#address").value.trim();
    const errAddress = $('[data-err="address"]');
    if(!address){ errAddress.textContent = "お住まいは必須です"; ok = false; } else { errAddress.textContent = ""; }

    // ⑤アレルギー
    const allergy = getRadioValue("allergy");
    const errAllergy = $('[data-err="allergy"]');
    if(!allergy){ errAllergy.textContent = "アレルギーの有無を選択してください"; ok = false; } else { errAllergy.textContent = ""; }

    if(allergy === "ある"){
      const detail = $("#allergyDetail").value.trim();
      const errDetail = $('[data-err="allergyDetail"]');
      if(!detail){ errDetail.textContent = "アレルギー内容をご記入ください"; ok = false; } else { errDetail.textContent = ""; }
    } else {
      $('[data-err="allergyDetail"]').textContent = "";
    }

    // ⑥まつエク経験
    const had = getRadioValue("hadExtensions");
    const errHad = $('[data-err="hadExtensions"]');
    if(!had){ errHad.textContent = "はい／いいえを選択してください"; ok = false; } else { errHad.textContent = ""; }

    // ⑦普段使用
    const eye = getRadioValue("eyeWear");
    const errEye = $('[data-err="eyeWear"]');
    if(!eye){ errEye.textContent = "一つ選択してください"; ok = false; } else { errEye.textContent = ""; }

    return ok;
  }

  function buildMessage(){
    const v = {
      name: $("#name").value.trim(),
      tel: $("#tel").value.trim(),
      birthday: $("#birthday").value.trim(),
      address: $("#address").value.trim(),
      allergy: getRadioValue("allergy"),
      allergyDetail: $("#allergyDetail").value.trim(),
      hadExtensions: getRadioValue("hadExtensions"),
      eyeWear: getRadioValue("eyeWear"),
      style: $("#style").value.trim(),
    };

    const lines = [];
    lines.push("≪カウンセリングシート≫");
    lines.push(`① お名前\n・${v.name}`);
    lines.push(`② お電話番号\n・${v.tel}`);
    if(v.birthday) lines.push(`③ 生年月日\n・${v.birthday}`);
    lines.push(`④ お住まい\n・${v.address}`);
    lines.push(`⑤ アレルギー\n・${v.allergy}` + (v.allergy === 'ある' && v.allergyDetail ? `\n・内容：${v.allergyDetail}` : ''));
    lines.push(`⑥ 過去にまつエク経験\n・${v.hadExtensions}`);
    lines.push(`⑦ 普段使用しているもの\n・${v.eyeWear}`);
    if(v.style) lines.push(`⑧ 希望スタイル\n・${v.style}`);

    return lines.join("\n\n");
  }

  async function ensureLiff(){
    if(!window.liff) throw new Error("LIFF SDK not loaded");
    if(!liff.isInClient()) return; // ブラウザ単体確認用に未ログインでも通す
    if(!liff.isInitialized()){
      await liff.init({ liffId: LIFF_ID });
    }
  }

  async function send(){
    const text = buildMessage();
    // liff外（ブラウザ）での動作確認：アラート表示のみ
    if(!window.liff || !liff.isInClient()){
      alert("プレビュー（LIFF外）：\n\n"+text);
      return;
    }
    await liff.sendMessages([{type:'text', text}]);
    alert('ご記入ありがとうございます。送信しました。');
    liff.closeWindow();
  }

  document.addEventListener('DOMContentLoaded', async () => {
    initChips();
    $$('input[name="allergy"]').forEach(i=>i.addEventListener('change', ()=>onChange('allergy')));

    $('#submitBtn').addEventListener('click', async () => {
      if(isSubmitting) return; // 多重タップ防止
      if(!validate()){
        window.scrollTo({top:0, behavior:'smooth'});
        return;
      }

      const btn = $('#submitBtn');
      const prevText = btn.textContent;
      isSubmitting = true;
      btn.disabled = true;
      btn.textContent = '送信中…';

      try{
        await ensureLiff();
        await send();
      }catch(err){
        console.error(err);
        alert('送信に失敗しました。ネットワーク環境をご確認のうえ再度お試しください。');
      } finally {
        // LIFF外プレビューやエラー時は元に戻す（LIFF内成功時はcloseWindowされる）
        btn.disabled = false;
        btn.textContent = prevText;
        isSubmitting = false;
      }
    });
        return;
      }
      try{
        await ensureLiff();
        await send();
      }catch(err){
        console.error(err);
        alert('送信に失敗しました。ネットワーク環境をご確認のうえ再度お試しください。');
      }
    });
  });
</script>
</body>
</html>
